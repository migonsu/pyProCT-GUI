<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
    
    <title>pyProClust: easy clustering for biomolecules</title>
    
    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="wizard/css/smoothness/jquery-ui-1.10.2.custom.min.css" media="screen">
    <link rel="stylesheet" type="text/css" href="wizard/css/ui/jquery.ui.selectmenu.css" media="screen">
    <link rel="stylesheet" type="text/css" href="wizard/css/basic.css"  media="screen">
    <link rel="stylesheet" type="text/css" href="wizard/css/wizard.css"  media="screen">
    <link rel="stylesheet" type="text/css" href="wizard/css/dynamicList.css"  media="screen">
    <link rel="stylesheet" type="text/css" href="wizard/css/fileBrowser.css"  media="screen">
    <link rel="stylesheet" type="text/css" href="wizard/js/jquery/filetree/filetree.css"  media="screen">
    <link rel="stylesheet" type="text/css" href="wizard/css/chemdoodle/ChemDoodleWeb.css"  media="screen">
    
    <!-- JQUERY -->
    <script type="text/javascript" src="wizard/js/jquery/jquery-1.9.1.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/js/jquery/ui/jquery-ui-1.10.0.custom.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/js/jquery/ui/selectmenu/jquery.ui.selectmenu.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/js/jquery/ui/dynamiclist/jquery.ui.dynamiclist.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/js/jquery/center/jquery.center.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/js/jquery/wizard/jquery.wizard.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/js/jquery/form/jquery.form.js"></script> 
    <script type="text/javascript" src="wizard/js/jquery/validate/jquery.validate.js"></script>
    <script type="text/javascript" src="wizard/js/jquery/filetree/filetree.js" charset="utf-8"></script>
    
    <!-- HANDLEBARS -->
    <script type="text/javascript" src="wizard/js/handlebars/handlebars-1.0.rc.1.min.js" charset="utf-8"></script>
    
    <!-- CHEMDOODLE -->
    <script type="text/javascript" src="wizard/js/chemdoodle/ChemDoodleWeb-libs.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/js/chemdoodle/ChemDoodleWeb.js" charset="utf-8"></script>
    
    <!-- SPINJS -->
    <script type="text/javascript" src="wizard/js/spinjs/spin.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/js/spinjs/jquery.spin.js" charset="utf-8"></script>    
    
    <!-- CUSTOM SCRIPTS -->
    <script type="text/javascript" src="wizard/js/tools.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/js/path_tools.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/js/cluster_params_field_templating.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/js/evaluation_criteria_handling.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/js/params_gathering.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/js/definitions/algorithm_parameters_description.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/js/definitions/algorithm_types.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/js/definitions/query_and_criteria_types.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/js/definitions/parameter_description.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/js/algorithm_parameter_parsers.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/js/dialogs.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/js/run_script.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/js/save_script.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/js/dialogs.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/js/main.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/js/selection_preview_handling.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/js/selection_preview_handling.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/js/wizard.control.js" charset="utf-8"></script>
    <script type="text/javascript" src="wizard/wizard.steps/steps.description.js" charset="utf-8"></script>
    
    <script>
        $(document).ready( function() {
        	//------------------
            // Template Loading
            //------------------
            var	dialog_contents_template = load_text_resource_with_ajax("wizard/templates/dialog_contents.template");
            
        	WIZARD_CONTROL.generate_wizard_course("#steps_wrapper","advanced");
        	
            main_function();
            
		 	//******************************
		 	// List of trajectories
		 	//******************************
            $("#trajectory_list").dynamiclist({height:150,buttons:["Add","Remove"]});
            var dl = $("#trajectory_list").dynamiclist("getListHandler");
            //dl.addElement('/home/victor/Desktop/test/1M94.pdb');
            dl.addElement('/home/victor/Escritorio/test/ubi_9_clusters.pdb');
            dl.buttons["Add"].click(function(){
            	var callback = function(value){
            		dl.addElement(value);
                };
            	browsing_dialog("file::pdb", callback);
            });
            dl.buttons["Remove"].click(function(){
                dl.deleteSelectedElements();
            });
            
          	//******************************
		 	// List of algorithms
		 	//******************************
            $("#algorithms_list").dynamiclist({height:160,buttons:["Algorithms","Add","Remove"]});
            var dl2 = $("#algorithms_list").dynamiclist("getListHandler");
            dl2.buttons["Algorithms"].replaceWith("<select class='dynListButton' id = 'algorithms_listbox'></select>")
         	// Add options to the cluster algorithms selection widget
           	$("#algorithms_listbox").append("<option id='all_option'>All</option>");
            for (clustering_algorithm in clustering_algorithm_titles){
                var title = clustering_algorithm_titles[clustering_algorithm];
                $("#algorithms_listbox").append("<option id='"+clustering_algorithm+"_option'>"+title+"</option>");
            }
            dl2.buttons["Add"].click(function(){
            	var algorithm = $("#algorithms_listbox option:selected").val();
            	if (algorithm != "All"){
            		dl2.addUniqueElement(algorithm);
            	}
            	else{
            		for (clustering_algorithm in clustering_algorithm_titles){
            			if (clustering_algorithm!="random"){
            				dl2.addUniqueElement(clustering_algorithm_titles[clustering_algorithm]);
            			}
            		}
            	}
            });
            dl2.buttons["Remove"].click(function(){
                dl2.deleteSelectedElements();
            });
            
          	//******************************
		 	// List of queries
		 	//******************************
            $("#query_list").dynamiclist({height:160,buttons:["Queries","Add","Remove"]});
            var dl4 = $("#query_list").dynamiclist("getListHandler");
            dl4.buttons["Queries"].replaceWith("<select class='dynListButton' id = 'queries_listbox'></select>")
            // Add options to the query listbox
            for (var i = 0; i < query_types.length; i++){
                $("#queries_listbox").append("<option>"+query_types[i]+"</option>");
            }
            dl4.buttons["Add"].click(function(){
                dl4.addUniqueElement($("#queries_listbox option:selected").val());
            });
            dl4.buttons["Remove"].click(function(){
                dl4.deleteSelectedElements();
            });
            
	        //******************************
		 	// List of criteria
		 	//******************************
            $("#criteria_list").dynamiclist({height:155,buttons:["Add Criteria","Remove"]});
            var dl3 = $("#criteria_list").dynamiclist("getListHandler");
            dl3.buttons["Add Criteria"].click(function(){
                criteria_creation_show_dialog(
			                			criteria_types, 
			                			dl3, 
			                        	dialog_contents_template);
            });
            dl3.buttons["Remove"].click(function(){
                dl3.deleteSelectedElements();
            });
            
            //******************************
		 	// Previewer widget creation
		 	//******************************        
            create_previewer(
            		'rmsdViewer',
            		"trajectory_list", 
            		"workspace_base",
            		[	
            		 	{
            		 		input_id:'rmsd_fit_selection',
            				button_id:"preview_rmsd_fit_button"
            		 	},
            		 	{
            		 		input_id:'rmsd_calc_selection',
            				button_id:"preview_rmsd_calc_button"
            		 	}
            		]
            );
            // Disable calc
            $("#calc_selection_label").addClass("disabled");
            $("#rmsd_calc_selection").prop('disabled', true);
            $("#rmsd_calc_selection").button("disable");
            $("#preview_rmsd_calc_button").button("disable");
            
            //Allow enabling calculation selection
            $("#usesamefitandcalc").click(function(){
            	 if($(this).prop('checked')){
            		 $("#calc_selection_label").addClass("disabled");
                     $("#rmsd_calc_selection").prop('disabled', true);
                     $("#rmsd_calc_selection").button("disable");
                     $("#preview_rmsd_calc_button").button("disable");
            	 }
            	 else{
            		 $("#calc_selection_label").removeClass("disabled");
                     $("#rmsd_calc_selection").prop('disabled', false);
                     $("#rmsd_calc_selection").button("enable");
                     $("#preview_rmsd_calc_button").button("enable");
            	 }
            });
            
            create_previewer(
            		'distanceViewer',
            		"trajectory_list", 
            		"workspace_base",
            		[	
            		 	{
            		 		input_id:'dist_fit_selection',
            				button_id:"preview_dist_fit_button"
            		 	},
            		 	{
            		 		input_id:'dist_calc_selection',
            				button_id:"preview_dist_calc_button"
            		 	}
            		]
            );
            
          	//******************************
		 	// File browsing
		 	//******************************      
            $("#browse_project_folder_button").click(function(){
                var callback = function(value){
                	$("#workspace_base").val(value);
                };
            	browsing_dialog("folder", callback);
            });
          	
            $("#browse_matrix_button").click(function(){
                    var callback = function(value){
                    	$("#matrix_creation_path").val(value);
                    };
                	browsing_dialog("file::npy", callback);
             });
            
            
            
            
            
            var selected_algorithms = [];
            
            $("#wizard-wrapper").wizard({
		        stepsWrapper: "#steps_wrapper",
		        
		        forward: ".forward",
		        
		        backward: ".backward",
		
			    onForwardMove: function(event, state) {	
			        
			    	var step = $(state.step[0]);
			        var step_id = state.step[0].id;
			        
			        console.log(step_id)
			        switch(step_id){
			            case 'workspace-1':
			                var file_path = step.find("#workspace_base")
			                					 .val();
					        if(file_path!=""){
				                var file_check  = file_exists(file_path);
				                
				                if(file_check["exists"]){
						            return true;
						        }
						        else{
						            var create_new_folder_question = yes_or_no_dialog ("Warning",
						            		"Folder does not exist, do you want to create it?");
		        
		                            create_new_folder_question.done(function(){
		                                create_folder(file_path);
		                                $("#wizard-wrapper").wizard("forward",[event,1]);
		                            });
						        }
					        }
					        else{
					        	warning_dialog ("The field cannot be empty.");
					        }
	                    	break;
	                    
			            case 'trajectory-1':
			            	if (!$("#trajectory_list").dynamiclist("isEmpty")){
				            	return true;
			            	}
			            	else{
			            		warning_dialog ("You have to add at least one trajectory.");
			            	}
			            	break;
			            
			            case "rmsd-1":
		            		if($("#rmsd_fit_selection").val() == "" || 
		            				(!step.find("#usesamefitandcalc").is(':checked') && 
		            						$("#rmsd_calc_selection").val() == "")){
					        	warning_dialog ("Fields cannot be empty.");
								return false;			            		
			            	}
		            		if (step.find("#usesamefitandcalc").is(':checked')){
		            			$("#rmsd_calc_selection").val($("#rmsd_fit_selection").val());
		            		}
							return true;				            	
			            	break;
			            
			            case "distance-1":
		            		if($("#dist_fit_selection").val() == "" || 
		            						$("#dist_calc_selection").val() == ""){
					        	warning_dialog ("Fields cannot be empty.");
								return false;			            		
			            	}
							return true;				            	
			            	break;
			            	
			            case 'load_matrix-1':
			            	if ($("#matrix_creation_path").val()!=""){
				            	return true;
			            	}
			            	else{
			            		warning_dialog ("You have to specify the file you want to load.");
			            	}
			            	break;
			            	
			            case 'algorithms-1':
			            	if (!$("#algorithms_list").dynamiclist("isEmpty")){
			            		var list = step.find(":custom-dynamiclist");
				            	selected_algorithms = list.dynamiclist("getValue").split(",");
				            	return true;
			            	}
			            	else{
			            		warning_dialog ("You have to add at least one clustering algorithm.");
			            	}
			           		break;

			            case 'algorithm-gromos':
			            case 'algorithm-hierarchical':
			            case 'algorithm-random':
			            case 'algorithm-spectral':
			            case 'algorithm-dbscan':
			            case 'algorithm-kmedoids':
			            	var cbox = step.find("[name='guess_params']");
			            	if(cbox.is(":checked")){
			            		return true;
			            	}
			            	else{
			            		var a_list_is_incorrect = false;
			            		
			            		step.find(":text").each(function(){
			            			if(!a_list_is_incorrect){
				            			if($(this).val() == ""){
				            				warning_dialog ("List must have at least one element.");
				            				a_list_is_incorrect = true;
				            				return;
				            			}
				            			else{
				            				console.log($(this).val());
				            				if(!has_list_format($(this).val())){
				            					a_list_is_incorrect = true;
				            					warning_dialog ("List has not the correct format.");
				            					return;
				            				}
				            			}
			            			}
			            			else{
			            				return;
			            			}
			            		});
			            		
			            		return ! a_list_is_incorrect;
			            	}
			            	break;
			            	
			            case 'criteria-2':
			            	if ($("#criteria_list").dynamiclist("isEmpty")){
			            		warning_dialog ("You need to define at least one selection criterium.");
			            		return false;
			            	}
			            	else{
			            		return true;
			            	}
			            	
			           		break;
	                    // What to do in the other cases
	                    default:
	                    	console.log("default validation")
	                        var inputs = step.find(':input');
	                    	
	                        if (inputs.size() == 0){
	                        	console.log("Input fields NOT found @ this step")
	                        	return true;
	                        }
	                        else{
	                        	console.log("Input fields found:")
	                        	if(inputs.length > 1){
	    	                    	for(var i = 0; i < inputs.size(); i++){
	    	                    		console.log("* "+$(inputs[i]).attr("id"));
	    	                    		if ($(inputs[i]).attr("name") == undefined){
	    	                    			$(inputs[i]).attr("name", $(inputs[i]).attr("id"))
	    	                    		}
	    	                    	}
	                        	}
	                            return inputs.valid();
	                        }
				
			        }
			        
			        return false;
			    },
			    
			    afterForward:function(event, state) {
			    	var step = $(state.step[0]);
			        var step_id = state.step[0].id;
			        
			        // detect an algorithm transition
			    	if(step_id.indexOf("algorithm-")!=-1){
			    		var algorithm_id = step_id.substring(10);
			    		console.log(algorithm_id)
			    		if($("#algorithms_list").dynamiclist("getListHandler").isAlreadyInTheList(clustering_algorithm_titles[algorithm_id])){
			    			console.log(algorithm_id+" it's being selected")
			    		}
			    		else{
			    			$("#wizard-wrapper").wizard("forward",[event,1]);
			    		}
			    	}
			    },
			    
			    afterBackward:function(event, state) {
			    	var step = $(state.step[0]);
			        var step_id = state.step[0].id;
			        
			        // detect an algorithm transition
			    	if(step_id.indexOf("algorithm-")!=-1){
			    		var algorithm_id = step_id.substring(10);
			    		console.log(algorithm_id)
			    		if($("#algorithms_list").dynamiclist("getListHandler").isAlreadyInTheList(clustering_algorithm_titles[algorithm_id])){
			    			console.log(algorithm_id+" it's being selected")
			    		}
			    		else{
			    			$("#wizard-wrapper").wizard("backward",[event,1]);
			    		}
			    			
			    	}
			    },
			    // Where to go in transitions
			    transitions: {
				    'matrix_creation_options': function($step, action) {
					    // The branch to go changes to reflect your choice.
					    var branch = $step.find("[name=matrix_creation_options]:checked").val();
					    return branch;
				    }
			    }
	        })
	        .wizard('form')
	        .validate();

            $("#run_button").button("option", "icons",{primary:"ui-icon-gear"});
            $("#run_button").click(function(){
            	var parameters = create_parameters(selected_algorithms);
            	ajax_run_script(parameters);
            });

            $("#script_button").button("option", "icons",{primary:"ui-icon-disk"});
            $("#script_button").click(function(){
            	var parameters = create_parameters(selected_algorithms);
            	ajax_save_script(parameters);
            });
            
            console.log(create_parameters(selected_algorithms));
            console.log(criteria_object_to_string({
				"criteria_0": { "CythonSilhouette":{"action": ">","weight": 0.9},
                 	"PCAanalysis":{"action": "<","weight": 1},          
                 	"NormNCut":{"action": ">","weight": 0.3}
				},
				"criteria_1": {	"CythonSilhouette":{"action": ">","weight": 0.8},
								"PCAanalysis":{"action": "<","weight": 1},
								"CythonMirrorCohesion":{"action": ">","weight": 0.2},
								"NormNCut":{"action": ">","weight": 0.1}
				}
            }));
            
            $("[name='guess_params']").each(function(){
            	$(this).parent().find("label[id!='guess_label']").addClass("disabled");
        		$(this).parent().find(":text").button("disable");
        		$(this).parent().find("select").selectmenu('disable');
            });
            
            $("[name='guess_params']").click(function(){
            	if($(this).is(":checked")){
            		$(this).parent().find("label[id!='guess_label']").addClass("disabled");
            		$(this).parent().find(":text").button("disable");
            		$(this).parent().find("select").selectmenu('disable');
            	}
            	else{
            		$(this).parent().find("label").removeClass("disabled");
            		$(this).parent().find(":text").button('enable');
            		$(this).parent().find("select").selectmenu('enable');
            	}
            });
            set_defaults_to_fields();
            create_parameters(selected_algorithms);
            console.log($.find("[name='guess_params']"));
    	}); 
        
    </script>
  </head>
  <body> 
<div class = 'main_frame' id="main"> 
    
  <div class = 'main_title_container'>
      <img src="wizard/img/pyproclust.png" >
  </div>
  
  <div class = 'main_window'> 
  
    <div id="wizard-wrapper" >
        <form name="main" id="steps_wrapper" class="step_wrapper">
        
	   </form>	
      </div>
    </div>
</div>
</body>
</html>
