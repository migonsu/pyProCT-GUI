
function create_previewer(
		input_id, 
		trajectories_dynamic_list_id, 
		base_workspace_field_id, 
		previewer_canvas_id){
	
	var viewerAllRed = new ChemDoodle.TransformCanvas3D(previewer_canvas_id, 125, 125);
    viewerAllRed.specs.set3DRepresentation('Ball and Stick');
    viewerAllRed.specs.backgroundColor = 'gray';
    
    
    var input_field = $("#"+input_id);
    input_field.keypress(function(event) {
    	  if ( event.which == 13 ) {
    		     event.preventDefault();
    		     var selection = input_field.val();
    		     var dl = $("#"+trajectories_dynamic_list_id).dynamiclist("getListHandler");
    		     var pdb_file = dl.value().split(",")[0]
    		     $.ajax({
    	              url: "/do_selection",
    	              
    	              type: "POST",
    	              
    	              async:false,
    	              
    	              data: JSON.stringify({
    	            	  selection: selection,
    	            	  pdb: pdb_file,
    	            	  base: $("#"+base_workspace_field_id).val()
    	              }),
    	              
    	              dataType: "text",
    	              
    	              complete: function(jqXHR, textStatus){
    	            	  //console.log(jqXHR.responseText)
    	            	  //var text = "REMARK%20Selection%20%27name%20CA%27%20from%20tmp_pdb_first_frame%0AATOM%20%20%20%20%20%201%20%20CA%20%20MET%20%20%20%20%201%20%20%20%20%20%2050.211%20%2049.417%20%20%207.174%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%20%202%20%20CA%20%20GLN%20%20%20%20%202%20%20%20%20%20%2053.842%20%2051.574%20%2010.223%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%20%203%20%20CA%20%20ILE%20%20%20%20%203%20%20%20%20%20%2052.833%20%2053.033%20%2013.715%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%20%204%20%20CA%20%20PHE%20%20%20%20%204%20%20%20%20%20%2056.213%20%2054.583%20%2014.792%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%20%205%20%20CA%20%20VAL%20%20%20%20%205%20%20%20%20%20%2055.918%20%2054.511%20%2018.118%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%20%206%20%20CA%20%20LYS%20%20%20%20%206%20%20%20%20%20%2057.185%20%2058.714%20%2020.261%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%20%207%20%20CA%20%20THR%20%20%20%20%207%20%20%20%20%20%2059.810%20%2058.581%20%2023.728%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%20%208%20%20CA%20%20LEU%20%20%20%20%208%20%20%20%20%20%2060.922%20%2061.253%20%2026.228%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%20%209%20%20CA%20%20THR%20%20%20%20%209%20%20%20%20%20%2064.459%20%2061.216%20%2024.758%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2010%20%20CA%20%20GLY%20%20%20%2010%20%20%20%20%20%2062.714%20%2062.016%20%2021.538%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2011%20%20CA%20%20LYS%20%20%20%2011%20%20%20%20%20%2063.947%20%2058.822%20%2018.929%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2012%20%20CA%20%20THR%20%20%20%2012%20%20%20%20%20%2061.590%20%2056.477%20%2017.610%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2013%20%20CA%20%20ILE%20%20%20%2013%20%20%20%20%20%2060.266%20%2053.753%20%2016.265%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2014%20%20CA%20%20THR%20%20%20%2014%20%20%20%20%20%2058.869%20%2053.385%20%2012.651%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2015%20%20CA%20%20LEU%20%20%20%2015%20%20%20%20%20%2056.461%20%2050.604%20%2013.644%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2016%20%20CA%20%20GLU%20%20%20%2016%20%20%20%20%20%2054.041%20%2048.031%20%2010.950%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2017%20%20CA%20%20VAL%20%20%20%2017%20%20%20%20%20%2051.047%20%2047.165%20%2012.599%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2018%20%20CA%20%20GLU%20%20%20%2018%20%20%20%20%20%2048.497%20%2044.793%20%2011.379%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2019%20%20CA%20%20PRO%20%20%20%2019%20%20%20%20%20%2045.833%20%2047.048%20%2013.211%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2020%20%20CA%20%20SER%20%20%20%2020%20%20%20%20%20%2042.171%20%2044.667%20%2014.053%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2021%20%20CA%20%20ASP%20%20%20%2021%20%20%20%20%20%2046.796%20%2044.386%20%2016.837%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2022%20%20CA%20%20THR%20%20%20%2022%20%20%20%20%20%2045.552%20%2045.452%20%2020.679%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2023%20%20CA%20%20ILE%20%20%20%2023%20%20%20%20%20%2048.557%20%2047.873%20%2022.207%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2024%20%20CA%20%20GLU%20%20%20%2024%20%20%20%20%20%2049.577%20%2042.814%20%2024.493%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2025%20%20CA%20%20ASN%20%20%20%2025%20%20%20%20%20%2050.560%20%2043.056%20%2022.127%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2026%20%20CA%20%20VAL%20%20%20%2026%20%20%20%20%20%2052.064%20%2047.065%20%2020.826%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2027%20%20CA%20%20LYS%20%20%20%2027%20%20%20%20%20%2053.611%20%2046.049%20%2024.888%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2028%20%20CA%20%20ALA%20%20%20%2028%20%20%20%20%20%2054.127%20%2043.563%20%2023.983%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2029%20%20CA%20%20LYS%20%20%20%2029%20%20%20%20%20%2056.678%20%2043.763%20%2019.184%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2030%20%20CA%20%20ILE%20%20%20%2030%20%20%20%20%20%2058.317%20%2046.381%20%2022.629%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2031%20%20CA%20%20GLN%20%20%20%2031%20%20%20%20%20%2060.001%20%2045.016%20%2024.807%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2032%20%20CA%20%20ASP%20%20%20%2032%20%20%20%20%20%2060.259%20%2042.482%20%2022.435%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2033%20%20CA%20%20LYS%20%20%20%2033%20%20%20%20%20%2063.137%20%2045.413%20%2019.877%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2034%20%20CA%20%20GLU%20%20%20%2034%20%20%20%20%20%2064.518%20%2047.480%20%2023.821%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2035%20%20CA%20%20GLY%20%20%20%2035%20%20%20%20%20%2063.319%20%2044.501%20%2025.233%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2036%20%20CA%20%20ILE%20%20%20%2036%20%20%20%20%20%2061.619%20%2048.197%20%2027.622%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2037%20%20CA%20%20PRO%20%20%20%2037%20%20%20%20%20%2057.776%20%2044.987%20%2031.179%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2038%20%20CA%20%20PRO%20%20%20%2038%20%20%20%20%20%2055.239%20%2046.413%20%2029.631%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2039%20%20CA%20%20ASP%20%20%20%2039%20%20%20%20%20%2054.149%20%2046.243%20%2033.833%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0AATOM%20%20%20%20%2040%20%20CA%20%20GLN%20%20%20%2040%20%20%20%20%20%2056.022%20%2050.321%20%2031.997%20%201.00%20%200.00%20%20%20%20%20%20%20%20%20%20%20C%0A"
    	                 // var my_response_object = $.parseJSON('{"pdb_contents":'+text+"}")//jqXHR.responseText);
    	     		      var molFile = decodeURIComponent(jqXHR.responseText)//my_response_object.pdb_contents)
    	     		      console.log(molFile)
    	                  var molecule = ChemDoodle.readPDB(molFile, 1);
    	     		      viewerAllRed.loadMolecule(molecule);
    	              },
    	              
    	              error:function( jqXHR, textStatus, errorThrown ){
    	                  alert( "Request failed: " + textStatus+". Is the server working?" );
    	              }
    	            });
    	  }
    });
}